<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-01-19 Tue 13:01 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title><code>moo</code> 無 <i>otypes</i></title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Brett Viren" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="other/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="other/readtheorg/css/readtheorg.css"/>
<script type="text/javascript" src="other/lib/js/jquery.min.js"></script>
<script type="text/javascript" src="other/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" src="other/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="other/readtheorg/js/readtheorg.js"></script>
<style> #content{max-width:1800px;}</style>
<style> p{max-width:800px;}</style>
<style> li{max-width:800px;}</style>
<style> pre.src{border-radius: 5px; background-color:#333; color:#0f0;}</style>
<style> pre.example{border-radius: 5px; background-color:#333; color:#0f0;}</style>
<style> code{border-radius: 5px; background-color:#333; color:#0f0;}</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title"><code>moo</code> 無 <i>otypes</i>
<br />
<span class="subtitle">Defining objects with <code>moo</code> <i>oschema</i> types</span>
</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc031bcb">Overview</a></li>
<li><a href="#org99c6bd0">Usage</a>
<ul>
<li><a href="#org53c3095">Individual type construction</a></li>
<li><a href="#orgc347324">Schema structure array</a></li>
<li><a href="#orgaa82906">Load types from file</a></li>
</ul>
</li>
<li><a href="#org2b00c82">Help</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgc031bcb" class="outline-2">
<h2 id="orgc031bcb">Overview</h2>
<div class="outline-text-2" id="text-orgc031bcb">
<p>
<b>moo</b> <i>otypes</i> is way to produce instances of <i>oschema</i> types that tries to
follow a <i>valid-by-construction</i> pattern.  In general, <i>otypes</i> are native
language types (eg those of Python) which derive from <i>oschema</i> schema
data structures.  
</p>

<p>
For example, in the <a href="oschema.html">oschema</a> document we saw some basic use of the
general <i>otypes</i> pattern applied as C++ codegen in the <code>structs.hpp.j2</code>
and <code>nljs.hpp.j2</code> templates.  When instantiating a codegen'ed C++ <code>struct</code>
we have some immediate validity guarantees.  They may then
automatically transfer to a JSON object that may be derived from the
C++ <code>struct</code>.
</p>

<p>
The rest of this document describes how <b>moo</b> applies the <i>otypes</i> pattern
in Python.  With the use of the <code>moo.otypes</code> Python module, user code
may access Python classes corresponding to <i>oschema</i> types and in
instantiating them as Python objects gain some <i>valid-by-construction</i>
guarantees.
</p>

<div class="info" id="orge4d42aa">
<p>
See also <a href="https://brettviren.github.io/dune-daq-repl/ddcmd.html">DUNE DAQ Command Object Creation</a> which describes <code>moo.otypes</code>
in the context of one particular application.
</p>

</div>
</div>
</div>

<div id="outline-container-org99c6bd0" class="outline-2">
<h2 id="org99c6bd0">Usage</h2>
<div class="outline-text-2" id="text-org99c6bd0">
<p>
The <code>moo.otypes</code> module provides high level functions to construct types
from <i>oschema</i>.  They make use of lower-level Python metaprogramming for
the actual type construction which is also in this module.
</p>
</div>

<div id="outline-container-org53c3095" class="outline-3">
<h3 id="org53c3095">Individual type construction</h3>
<div class="outline-text-3" id="text-org53c3095">
<p>
We may make an individual type from <i>oschema</i> data structure which is
expressed as keyword arguments to the <code>moo.otypes.make_type()</code> function.
For example:
</p>

<div class="org-src-container">
<pre class="src src-python">import moo.otypes
Age = moo.otypes.make_type(
    name="Age", doc="An age in years",
    schema="number", dtype='i4', path='a.b')
myage = Age(42)  # my forever age
print(f'{Age}, {myage}, {myage.pod()}')
import a.b
myage2 = Age(18)
print(f'{a.b.Age}, {myage2}, {myage2.pod()}')

</pre>
</div>

<pre class="example">
&lt;class 'a.b.Age'&gt;, &lt;number Age: 42&gt;, 42
&lt;class 'a.b.Age'&gt;, &lt;number Age: 18&gt;, 18
</pre>


<div class="note" id="orgffbc150">
<p>
The <code>moo.otypes.make_type()</code> directly returns a Python type object (aka
Python class) and it "places" the type object into the module tree
given the schema structure's <code>.path</code> attribute.  
</p>

</div>

<p>
We may try to use our otype with invalid data:
</p>

<pre class="example" id="org941d5c2">
myage = Age("older than the hills")
</pre>

<p>
Which will return an error like:
</p>

<pre class="example" id="orgfc1a6d2">
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 8, in &lt;module&gt;
  File "&lt;number Age&gt;", line 13, in __init__
  File "/home/bv/dev/moo/moo/otypes.py", line 485, in update
    self._value = numpy.array(val, dtype)
ValueError: invalid literal for int() with base 10: 'older than the hills'
</pre>

<p>
This error illustrates how the <i>valid-by-construction</i> pattern works.
It's not that magic is performed and the data is miraculously valid.
Rather, we the developer are immediately punished if we attempt to
violate the schema.  
</p>

<div class="note" id="org4f2fbda">
<p>
We may also produce an object from these (or more generic) types and
validate that object against schema.  It is important to know that the
constraints asserted by these two validation procedures are somewhat
disjoint.  As <code>moo.otypes</code> matures it may gain more rigor, but for now
the JSON Schema based validation on a final object will catch mistakes
that <code>moo.otypes</code> will miss during object construction.
</p>

</div>
</div>
</div>


<div id="outline-container-orgc347324" class="outline-3">
<h3 id="orgc347324">Schema structure array</h3>
<div class="outline-text-3" id="text-orgc347324">
<p>
Creation of a <i>system of related types</i> is done with an array of data
structures describing its schema and the Python types are constructed
with the plural function <code>moo.otypes.make_types()</code>.  For example:
</p>

<div class="org-src-container">
<pre class="src src-python">import moo.otypes
schema = [dict(name="Pet", schema="enum",
               symbols=["cat", "dog", "early personal computer"],
               default="cat",
               path="my.home.office",
               doc="A kind of pet"),
          dict(name="Desk", schema="record",
               fields=[
                   dict(name="ontop", item="my.home.office.Pet"),
               ],
               path="my.home.office",
               doc="Model my desk")]
moo.otypes.make_types(schema)

from my.home.office import Desk, Pet
desk = Desk(ontop="cat")
print(f'{Desk}, {desk}, {desk.pod()}, {desk.ontop}')
</pre>
</div>

<pre class="example">
&lt;class 'my.home.office.Desk'&gt;, &lt;record Desk, fields: {ontop}&gt;, {'ontop': 'cat'}, cat
</pre>


<div class="note" id="orgd33ab89">
<p>
The schema structure array is assumed to be sorted in topological
order of type dependencies.  Here, this is implicitly assured by how
the <code>schema</code> array is formed.  In more complex code one may rely on
<code>moo.oschema.toposort()</code> to produce a sorted schema array.
</p>

</div>
</div>
</div>

<div id="outline-container-orgaa82906" class="outline-3">
<h3 id="orgaa82906">Load types from file</h3>
<div class="outline-text-3" id="text-orgaa82906">
<p>
The highest layer function is <code>moo.otypes.load_types()</code>.  It is a mere
convenience function that combines the <b>moo</b> method to load a schema
file and a call to <code>make_types()</code> on the result.  
</p>

<div class="note" id="org0cdd41d">
<p>
Any file format that <b>moo</b> supports may be used to provide schema, while
Jsonnet is recommended.  See the <a href="oschema.html">oschema</a> document for more details on
how to construct schema files.
</p>

</div>

<p>
We can see <code>load_types()</code> in action using a schema that is part of the
<b>moo</b> test suite:
</p>

<div class="org-src-container">
<pre class="src src-python">import os
import moo.otypes

# Directly make a type in Python to use for an "any" below
moo.otypes.make_type(schema="string", name="Uni", path="test.basetypes")
from test.basetypes import Uni

# We locate and load a test schema file
here = os.path.join(os.path.dirname(__file__), "test")
types = moo.otypes.load_types("test-ogen-oschema.jsonnet", [here])

from app import Person
per = Person(email="foo@example.com", counts=[42],
             affil=Uni("Snooty U"), mbti="judging")
print(f'{Person}, {per}, {per.affil}')
print(per.pod())
</pre>
</div>

<pre class="example">
&lt;class 'app.Person'&gt;, &lt;record Person, fields: {email, counts, affil, mbti}&gt;, Snooty U
{'email': 'foo@example.com', 'counts': [42], 'affil': 'Snooty U', 'mbti': 'judging'}
</pre>



<div class="note" id="orgcaefb5e">
<p>
In the above we give <code>load_types()</code> a file system path (ie, <code>[here]</code>) so
that in the <b>moo</b> test suite directory will be located.  <b>moo</b> will search
this path when a file is given as a relative path.
</p>

<p>
When using <code>moo</code> Python module the application may set a default path
instead of providing one to every <code>moo.io.load()</code> call (which
<code>load_types()</code> forwards to).  An example of this usage is given below.
</p>

<p>
When using the <code>moo</code> CLI one may set the environment variable
<code>MOO_LOAD_PATH</code> to equivalently provide this default load path.
</p>

</div>
</div>
</div>
</div>


<div id="outline-container-org2b00c82" class="outline-2">
<h2 id="org2b00c82">Help</h2>
<div class="outline-text-2" id="text-org2b00c82">
<p>
Type information and any <code>doc</code> strings given in the schema are reflected
into the constructed Python types.  This information can be displayed
using usual Python meta interrogation methods.  For example:
</p>

<div class="org-src-container">
<pre class="src src-python">import os
import moo.otypes
import moo.io

here = os.path.join(os.path.dirname(__file__), "test")
moo.io.default_load_path = [here]
types = moo.otypes.load_types("test-ogen-oschema.jsonnet")

from app import Person

help(Person)
</pre>
</div>

<pre class="example" id="orgc3faa42">
Help on class Person in module app:

class Person(moo.otypes.Record)
 |  Person(*args, email: app.Email = None, counts: app.Counts = None, affil: app.Affiliation = None, mbti: app.MBTI = 'introversion')
 |  
 |  Record type Person with fields: "email", "counts", "affil", "mbti"
 |  
 |  Describe everything there is to know about an individual human
 |  
 |  Method resolution order:
 |      Person
 |      moo.otypes.Record
 |      moo.otypes.BaseType
 |      abc.ABC
 |      builtins.object
 |  
 |  Methods defined here:
 |  
 |  __init__(self, *args, email: app.Email = None, counts: app.Counts = None, affil: app.Affiliation = None, mbti: app.MBTI = 'introversion')
 |      Create a record type of Person
 |  
 |  ----------------------------------------------------------------------
 |  Data descriptors defined here:
 |  
 |  affil
 |  
 |  counts
 |  
 |  email
 |  
 |  mbti
 |  
 |  ----------------------------------------------------------------------
 |  Data and other attributes defined here:
 |  
 |  __abstractmethods__ = frozenset()
 |  
 |  ----------------------------------------------------------------------
 |  Methods inherited from moo.otypes.Record:
 |  
 |  __repr__(self)
 |      Return repr(self).
 |  
 |  pod(self)
 |      Return record as plain old data.
 |      
 |      Will perform validation.
 |  
 |  update(self, *args, **kwds)
 |      Update a record.
 |      
 |      An arg in args may be one of:
 |      - a JSON string
 |      - a dictionary
 |      - an instance of a record of same type.
 |      
 |      kwds may be a dictionary.
 |      
 |      Dictionaries are taken to be field settings, values can be POD
 |      or a typed object consistent with the field type.
 |  
 |  ----------------------------------------------------------------------
 |  Readonly properties inherited from moo.otypes.Record:
 |  
 |  field_names
 |      Return list of field names
 |  
 |  fields
 |      Return mapping of field name to field dict
 |  
 |  ----------------------------------------------------------------------
 |  Readonly properties inherited from moo.otypes.BaseType:
 |  
 |  ost
 |      The object schema type
 |  
 |  ----------------------------------------------------------------------
 |  Data descriptors inherited from moo.otypes.BaseType:
 |  
 |  __dict__
 |      dictionary for instance variables (if defined)
 |  
 |  __weakref__
 |      list of weak references to the object (if defined)

</pre>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Brett Viren</p>
<p class="date">Created: 2021-01-19 Tue 13:01</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
